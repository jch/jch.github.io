#!/usr/bin/env ruby
require "open3"
require "time"
require 'debug'

rss_items = []
html_files = `find #{ENV["output_dir"]} -type f -name '*.html' | sort -r`
html_files.each_line do |path|
  html_content = File.read(path.chomp)

  # Extract title from HTML title tag or first h1
  case html_content
  when /<title[^>]*>(.*?)<\/title>/m
    title = $1.strip.gsub(/<[^>]*>/, '')  # Remove any HTML tags from title
  when /<h1[^>]*>(.*?)<\/h1>/m
    title = $1.strip.gsub(/<[^>]*>/, '')  # Remove any HTML tags from title
  else
    raise "Unable to find title from html for #{path}"
  end

  # Remove everything up to and including <body>
  html_content = html_content.sub(/.*?<div class="markdown-heading">.*?<\/div>/mi, '')

  # Remove everything from </body> onwards
  html_content = html_content.sub(/<\/body.*/mi, '')

  href = path

  # Extract date from file name
  if path =~ /(\d{4}-\d{2}-\d{2})/
    date = Time.parse($1).rfc822
  else
    date = File.mtime(path.chomp).rfc822
  end
  rss_items << <<-ITEM
<item>
  <title>#{title}</title>
  <link>https://jch.github.io/#{href}</link>
  <guid>https://jch.github.io/#{href}</guid>
  <pubDate>#{date}</pubDate>
  <description><![CDATA[#{html_content}]]></description>
</item>
  ITEM
end

rss_feed = <<-RSS
<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
  <title>Jerry Cheung</title>
  <link>https://jch.github.io/</link>
  <description>Jerry Cheung blog posts</description>
  <atom:link href="https://jch.github.io/rss.xml" rel="self" type="application/rss+xml" />
  #{rss_items.join("\n")}
</channel>
</rss>
RSS

File.open("#{ENV['root_dir']}/rss.xml", "w") { |fh| fh.puts(rss_feed) }
