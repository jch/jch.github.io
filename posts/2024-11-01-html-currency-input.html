<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <!-- Google fonts -->
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Minimize overriden styles for easy maintenance. Add classes to layouts
    where possible so content is style agnostic -->
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <div class="container" role="banner">
      <header>
        <a href="/" class="home">Jerry Cheung</a>
        <nav class="nav nav-inline pull-xs-right">
          <a class="nav-link" href="/projects">Projects</a>
          <a class="nav-link" href="/about">About</a>
        </nav>
      </header>

      <div class="markdown-heading"><h1 class="heading-element">Progressive HTML Currency Input</h1><a id="user-content-progressive-html-currency-input" class="anchor" aria-label="Permalink: Progressive HTML Currency Input" href="#progressive-html-currency-input"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>When entering a money value, I like to see the number in my locale. For example, <code>1000000</code> is easier to read as <code>$1,000,000</code>, but a German would expect <code>1.000.000 â‚¬</code>. There are many different approaches spanning a decade+ of internet posts. This post talks about the difference approaches and tradeoffs, and what I implemented for my app <a href="https://jch.app" rel="nofollow">https://jch.app</a>.</p>
<div class="markdown-heading"><h2 class="heading-element">Context</h2><a id="user-content-context" class="anchor" aria-label="Permalink: Context" href="#context"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>In my app, users can enter a financial independence goal and their annual expenses. These numbers can be thousands or millions, so it's more readable to have a currency symbol and some separators. My goals are:</p>
<ul>
<li>Form submits a numeric value</li>
<li>Cursor doesn't jump around when user is editing the value</li>
<li>Preview a formatted currency</li>
</ul>
<div class="markdown-heading"><h2 class="heading-element">1. Basic HTML input</h2><a id="user-content-1-basic-html-input" class="anchor" aria-label="Permalink: 1. Basic HTML input" href="#1-basic-html-input"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p><code>&lt;input type="number" /&gt;</code> has built-in browser validation and a numeric keyboard on mobile. The step controls make sense if you want to make it easy for users to go up or down by $1 or $0.01, but different people have very different FI numbers and annual expenses.</p>
<p>From the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/number#using_number_inputs" rel="nofollow">MDN docs</a>:</p>
<blockquote>
<p>The number input type should only be used for incremental numbers, especially when spinbutton incrementing and decrementing are helpful to user experience. The number input type is not appropriate for values that happen to only consist of numbers but aren't strictly speaking a number, such as postal codes in many countries or credit card numbers.</p>
</blockquote>
<p><code>&lt;input type="text" inputmode="decimal /&gt;</code> still gives a numberic keyboard on mobile, but skips the step controls. I started with this, but ran into readability issues for bigger numbers.</p>
<div class="markdown-heading"><h2 class="heading-element">2. Choose a common value</h2><a id="user-content-2-choose-a-common-value" class="anchor" aria-label="Permalink: 2. Choose a common value" href="#2-choose-a-common-value"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>A donation site might have buttons for $5, $10, $20, $100, and a custom donation amount. This makes sense if you want to anchor a user to some suggested value. It's also helpful if it helps users do some calculation like a percentage based tip. I thought about making a default like $1MM for an FI goal, but again, I didn't think it was better to have a default value.</p>
<div class="markdown-heading"><h2 class="heading-element">3. Masking with a formatted value</h2><a id="user-content-3-masking-with-a-formatted-value" class="anchor" aria-label="Permalink: 3. Masking with a formatted value" href="#3-masking-with-a-formatted-value"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>There are a lot of libraries that format currency as a user types (see notes). React seems the most popular at the moment (2024), but there are posts for jQuery from a decade ago. Looking at the source for these libraries was helpful:</p>
<ul>
<li>Setting an input's value resets it's cursor position to the end</li>
<li>Attempts to maintain cursor position programmatically while formatting the same text is complex, buggy, and brittle</li>
</ul>
<p>Banking apps have the best implementation of this approach. To prevent the cursor jumping around while editing, they force the cursor to the beginning or the end.</p>
<p>Bank of America starts the cursor at the end. As you enter numbers, the cursor stays at the end and fills in each digit from right to left ($0.01 $0.12 $1.23 $12.34) Weirdly, it also lets you move the cursor to the front, but it jumps back to the end when you enter a number ($0.00, enter a 2 gives you $20.00 and the cursor is at the end again.)</p>
<p>Paypal's approach feels more intuitive. It starts the cursor at the beginning ($), adding commas as you type left to right ($1 $12 $123 $1,234). It forbids you from moving the cursor to change the middle. You have to delete to go back, and it updates any separators as you edit.</p>
<p>While I like PayPal's experience in a native context, I don't want to fight the browser and try to override the cursor position.</p>
<div class="markdown-heading"><h2 class="heading-element">4. Preview formatted money when not editing</h2><a id="user-content-4-preview-formatted-money-when-not-editing" class="anchor" aria-label="Permalink: 4. Preview formatted money when not editing" href="#4-preview-formatted-money-when-not-editing"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>A variant to masking with a formatted value, separating the visual formatted value from the input's number value simplifies the implementation, but isn't as intuitive for user experience. My favorite example of this is in spreadsheets. A cell with a numeric value can be formatted in different ways, but the underlying value is still a number. When you edit the cell, there are no separators. Only when you finish editing (cell loses focus), does the value get formatted.</p>
<p>Here's one implementation that does this, but reusing the same form control means that the server has to parse the formatted value back to a number. The React component kept separate state for the formatted value and the raw number value.</p>
<div class="highlight highlight-text-html-basic"><pre><span class="pl-kos">&lt;</span><span class="pl-ent">label</span><span class="pl-kos">&gt;</span>
  <span class="pl-kos">&lt;</span><span class="pl-ent">p</span><span class="pl-kos">&gt;</span>Try entering some long and short numbers...<span class="pl-kos">&lt;/</span><span class="pl-ent">p</span><span class="pl-kos">&gt;</span>
  <span class="pl-kos">&lt;</span><span class="pl-ent">input</span> <span class="pl-c1">class</span>="<span class="pl-s">currency</span>" <span class="pl-c1">inputmode</span>="<span class="pl-s">decimal</span>" <span class="pl-c1">type</span>="<span class="pl-s">text</span>" <span class="pl-c1">value</span>="<span class="pl-s">1234.56</span>" <span class="pl-c1">style</span>="<span class="pl-s">padding: 0.5em; font-size: 1.2em</span>"<span class="pl-kos">&gt;</span>
<span class="pl-kos">&lt;/</span><span class="pl-ent">label</span><span class="pl-kos">&gt;</span></pre></div>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">&lt;</span><span class="pl-ent">script</span> <span class="pl-c1">id</span><span class="pl-c1">=</span><span class="pl-s">"currencyJs"</span> <span class="pl-c1">type</span><span class="pl-c1">=</span><span class="pl-s">"module"</span><span class="pl-c1">&gt;</span>
  const iso_4217 = <span class="pl-kos">{</span>
    <span class="pl-s">'en-US'</span>: <span class="pl-s">'USD'</span><span class="pl-kos">,</span>
    <span class="pl-s">'en-GB'</span>: <span class="pl-s">'GBP'</span><span class="pl-kos">,</span>
    <span class="pl-s">'de-DE'</span>: <span class="pl-s">'EUR'</span><span class="pl-kos">,</span>
    <span class="pl-s">'fr-FR'</span>: <span class="pl-s">'EUR'</span><span class="pl-kos">,</span>
    <span class="pl-s">'es-ES'</span>: <span class="pl-s">'EUR'</span><span class="pl-kos">,</span>
    <span class="pl-s">'it-IT'</span>: <span class="pl-s">'EUR'</span><span class="pl-kos">,</span>
    <span class="pl-s">'ja-JP'</span>: <span class="pl-s">'JPY'</span><span class="pl-kos">,</span>
    <span class="pl-s">'zh-CN'</span>: <span class="pl-s">'CNY'</span><span class="pl-kos">,</span>
    <span class="pl-s">'ko-KR'</span>: <span class="pl-s">'KRW'</span><span class="pl-kos">,</span>
    <span class="pl-s">'ru-RU'</span>: <span class="pl-s">'RUB'</span><span class="pl-kos">,</span>
    <span class="pl-s">'ar-SA'</span>: <span class="pl-s">'SAR'</span><span class="pl-kos">,</span>
    <span class="pl-s">'hi-IN'</span>: <span class="pl-s">'INR'</span><span class="pl-kos">,</span>
    <span class="pl-s">'pt-BR'</span>: <span class="pl-s">'BRL'</span><span class="pl-kos">,</span>
    <span class="pl-s">'tr-TR'</span>: <span class="pl-s">'TRY'</span><span class="pl-kos">,</span>
    <span class="pl-s">'nl-NL'</span>: <span class="pl-s">'EUR'</span><span class="pl-kos">,</span>
    <span class="pl-s">'pl-PL'</span>: <span class="pl-s">'PLN'</span><span class="pl-kos">,</span>
    <span class="pl-s">'th-TH'</span>: <span class="pl-s">'THB'</span><span class="pl-kos">,</span>
    <span class="pl-s">'vi-VN'</span>: <span class="pl-s">'VND'</span><span class="pl-kos">,</span>
    <span class="pl-s">'id-ID'</span>: <span class="pl-s">'IDR'</span><span class="pl-kos">,</span>
    <span class="pl-s">'ms-MY'</span>: <span class="pl-s">'MYR'</span><span class="pl-kos">,</span>
  <span class="pl-kos">}</span>;

  const CurrencyInput = class <span class="pl-kos">{</span>
    <span class="pl-en">constructor</span><span class="pl-kos">(</span><span class="pl-s1">element</span><span class="pl-kos">)</span><span class="pl-kos"></span> <span class="pl-kos">{</span>
      <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">element</span> <span class="pl-c1">=</span> <span class="pl-s1">element</span><span class="pl-kos">;</span>
      <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">locale</span> <span class="pl-c1">=</span> <span class="pl-s1">navigator</span><span class="pl-kos">.</span><span class="pl-c1">language</span> <span class="pl-c1">||</span> <span class="pl-s1">navigator</span><span class="pl-kos">.</span><span class="pl-c1">userLanguage</span> <span class="pl-c1">||</span> <span class="pl-s">'en-US'</span><span class="pl-kos">;</span>
      <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">element</span><span class="pl-kos">.</span><span class="pl-en">addEventListener</span><span class="pl-kos">(</span><span class="pl-s">'blur'</span><span class="pl-kos">,</span> <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">format</span><span class="pl-kos">.</span><span class="pl-en">bind</span><span class="pl-kos">(</span><span class="pl-smi">this</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
      <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">element</span><span class="pl-kos">.</span><span class="pl-en">addEventListener</span><span class="pl-kos">(</span><span class="pl-s">'focus'</span><span class="pl-kos">,</span> <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">unformat</span><span class="pl-kos">.</span><span class="pl-en">bind</span><span class="pl-kos">(</span><span class="pl-smi">this</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
      <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-en">format</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    get formatter() <span class="pl-kos">{</span>
      <span class="pl-s1">return</span> <span class="pl-k">new</span> <span class="pl-v">Intl</span><span class="pl-kos">.</span><span class="pl-c1">NumberFormat</span><span class="pl-kos">(</span><span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">locale</span><span class="pl-kos">,</span> <span class="pl-kos">{</span>
        <span class="pl-c1">style</span>: <span class="pl-s">"currency"</span><span class="pl-kos">,</span>
        <span class="pl-c1">currency</span>: <span class="pl-s1">iso_4217</span><span class="pl-kos">[</span><span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">locale</span><span class="pl-kos">]</span> <span class="pl-c1">||</span> <span class="pl-s">'USD'</span><span class="pl-kos">,</span>
      <span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>

    format() <span class="pl-kos">{</span>
      <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">raw</span> <span class="pl-c1">=</span> <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">element</span><span class="pl-kos">.</span><span class="pl-en">value</span><span class="pl-kos">;</span>

      <span class="pl-k">if</span> <span class="pl-kos">(</span><span class="pl-c1">!</span><span class="pl-en">isNaN</span><span class="pl-kos">(</span><span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">element</span><span class="pl-kos">.</span><span class="pl-c1">value</span><span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos"></span> <span class="pl-kos">{</span>
        <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">element</span><span class="pl-kos">.</span><span class="pl-c1">value</span> <span class="pl-c1">=</span> <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">formatter</span><span class="pl-kos">.</span><span class="pl-en">format</span><span class="pl-kos">(</span><span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">element</span><span class="pl-kos">.</span><span class="pl-c1">value</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
      <span class="pl-kos">}</span>
    <span class="pl-kos">}</span>

    <span class="pl-s1">unformat</span><span class="pl-kos">(</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
      <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">element</span><span class="pl-kos">.</span><span class="pl-c1">value</span> <span class="pl-c1">=</span> <span class="pl-smi">this</span><span class="pl-kos">.</span><span class="pl-c1">raw</span><span class="pl-kos">;</span>
    <span class="pl-kos">}</span>
  <span class="pl-kos">}</span><span class="pl-kos">;</span>

  <span class="pl-k">new</span> <span class="pl-v">CurrencyInput</span><span class="pl-kos">(</span><span class="pl-smi">document</span><span class="pl-kos">.</span><span class="pl-s1">querySelector</span><span class="pl-kos">(</span>'<span class="pl-kos">.</span><span class="pl-s1">currency</span>'<span class="pl-kos">)</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-c1">&lt;</span><span class="pl-c1">/</span><span class="pl-ent">script</span><span class="pl-c1">&gt;</span></pre></div>
<div class="markdown-heading"><h2 class="heading-element">5. Form submits a number</h2><a id="user-content-5-form-submits-a-number" class="anchor" aria-label="Permalink: 5. Form submits a number" href="#5-form-submits-a-number"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>To submit a number and display a formatted value, I create a 2nd input element and toggle the visibility on focus and blur. The formatted input does not have a <code>name</code> attribute, so it is not submitted with the form, while the original input keeps the number value. This is more complex, but keeps the changes localized at the input element so the form does not need to be aware. It's also a progressive enhancement of the original input, allowing it to work without javascript.</p>
<p><a target="_blank" rel="noopener noreferrer" href="/images/currency-input.gif"><img src="/images/currency-input.gif" width="220" height="480" style="max-width: 100%;"></a></p>
<div class="markdown-heading"><h2 class="heading-element">Conclusion</h2><a id="user-content-conclusion" class="anchor" aria-label="Permalink: Conclusion" href="#conclusion"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<p>The separation of the numeric value for form submission from visual presentation is key. Trying to maintain the state of both through input.value isnâ€™t sufficient. React has a advantage here for managing state, and I'm following a simliar pattern by maintaining the number state and formatted state in the DOM.</p>
<p>Similar to the approach detailed in the notes, I format as a currency when an input loses focus, and switch back to the raw value when the input is being edited. The increased complexity of maintaining cursor position was not worth the improvement in user experience.</p>
<div class="markdown-heading"><h2 class="heading-element">Notes</h2><a id="user-content-notes" class="anchor" aria-label="Permalink: Notes" href="#notes"><span aria-hidden="true" class="octicon octicon-link"></span></a></div>
<ul>
<li>
<code>navigator.language</code> is widely available for locale information</li>
<li>ISO 4217 defines currency codes by locale</li>
<li>
<code>Intl.NumberFormat</code> and <code>Number.prototype.toLocaleString</code> can format numbers as locale-aware currencies</li>
<li>
<a href="https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#concept-textarea/input-selection" rel="nofollow">https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#concept-textarea/input-selection</a> cursor position on input update</li>
<li>Why not use a number input type? <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/number#using_number_inputs" rel="nofollow">https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/number#using_number_inputs</a>
</li>
<li>Format onblur, use real value when editing: <a href="https://levelup.gitconnected.com/creating-a-localized-currency-input-in-react-without-libraries-or-bugs-2f186124aedc?gi=b8408a661baa" rel="nofollow">https://levelup.gitconnected.com/creating-a-localized-currency-input-in-react-without-libraries-or-bugs-2f186124aedc?gi=b8408a661baa</a>
</li>
<li>Cursor position arithmetic, too complex to maintain: <a href="https://stackoverflow.com/a/39279790" rel="nofollow">https://stackoverflow.com/a/39279790</a>
</li>
<li>
<a href="https://github.com/toarm/number-format?tab=readme-ov-file">https://github.com/toarm/number-format?tab=readme-ov-file</a> web component for display, but not an extension on input</li>
<li>
<a href="https://github.com/IngressoRapidoWebComponents/money-input?tab=readme-ov-file">https://github.com/IngressoRapidoWebComponents/money-input?tab=readme-ov-file</a> web component on input, has cursor position issue</li>
<li><a href="https://devtoolstips.org/tips/en/inspect-user-agent-dom/" rel="nofollow">https://devtoolstips.org/tips/en/inspect-user-agent-dom/</a></li>
<li>Forcing input cursor to the end: <a href="https://stackoverflow.com/questions/511088/use-javascript-to-place-cursor-at-end-of-text-in-text-input-element" rel="nofollow">https://stackoverflow.com/questions/511088/use-javascript-to-place-cursor-at-end-of-text-in-text-input-element</a>
</li>
<li>Replacing the inputâ€™s value on change puts the cursor at the end of the input, while using setRangeText gives more control over where the cursor lands. Attempts to solve this programmatically with arithmetic on <code>input.selectionStart</code> and <code>input.selectionEnd</code> are brittle.</li>
</ul>
    </div>

    <!-- jQuery first, then Bootstrap JS. -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js" integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7" crossorigin="anonymous"></script>
  </body>
</html>
