<!DOCTYPE html>
<html>
<head>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<title>
Picking at Capistrano
</title>
<link href="../../../../assets/application-d2f36cb0fed8eb4314e72d8f93f02530.css" media="all" rel="stylesheet" type="text/css" />
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2747647-1']);
  _gaq.push(['_setSiteSpeedSampleRate', 100]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>
<body class='container-fluid'>
<div class='full-width' id='wcc'>
<div id='header'>
<a href="../../../../index.html">whatcodecraves.com</a>
</div>

<div id='main'>
<div id="carbonads-container">
  <div class="carbonad">
    <div id="azcarbon"></div>
      <script type="text/javascript">
        var z = document.createElement("script");
        z.type = "text/javascript";
        z.async = true;
        z.src = "http://engine.carbonads.com/z/17311/azcarbon_2_1_0_VERT";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(z, s);
      </script>
    </div>
  </div>
<div class='post'>
<h1>Picking at Capistrano</h1>
<a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
<a href="https://twitter.com/share" class="twitter-share-button" data_via="whatcodecraves">Tweet</a>
<div class='g-plus' data-action='share' data-annontation='bubble'></div>
<p>Here is the setup I wanted with <a href="http://www.capify.org/">Capistrano</a>
with my <a href="http://housing.whatcodecraves.com/">housing app</a>.  I wanted
to develop locally and continue using Subversion over SSH for source
control.  Meanwhile, Cap would run svn commands remotely with
basic svnserve.  My first configuration looked like this:</p><pre><code>set :repository, "file:///var/svn/#{application}/trunk"
set :user, "myuser"
</code></pre><p>My reasoning was that cap would first ssh to my server, and then run</p><pre><code>svn checkout file:///var/svn/housing/trunk /path/to/deploy
</code></pre><p>Since I use a private key to authenticate to my server, I wouldn't
need to type my password to start the initial ssh connection, and cap
wouldn't need a password to access the repository because it would
execute commands on the remote server with "file:///"</p><p>It turns out that SCM commands are run locally rather than remotely.
The implication is that my ":repository" variable has to be accessible
both locally and remotely.  With ":repository" set to "file:///" cap
tried to determine the revision number by running 'svn info' locally.
Of course, this failed miserably because the repository existed on the
remote server.</p><p>Once I figured this out, I thought it'd be a simple matter of changing
the config to say:</p><pre><code>set :repository, "svn+ssh://whatcodecraves.com/var/svn/#{application}/trunk"
</code></pre><p>Now cap will happily run svn locally because it'll work over
"svn+ssh://".  Unfortunately, this also had a huge flaw.  When cap
tries to run the checkout command remotely, it'll use "svn+ssh://".
But because my private key isn't stored on the server, cap will give
three feeble attempts before croaking:</p><pre><code>** [208.53.44.43 :: err] Permission denied, please try again.
** [208.53.44.43 :: err] Permission denied, please try again.
** [208.53.44.43 :: err] Permission denied (publickey,password).
** [208.53.44.43 :: err] svn: Connection closed unexpectedly
</code></pre><p>What's weird about this is that I didn't ask cap to use public key
authentication, but it didn't give me any choice in the matter!
Crawling the internet yielded a lot of noise about poorly configured
repositories or basic explanations about public key authentication.
Finally, I came across <a href="http://groups.google.com/group/capistrano/browse_thread/thread/13b029f75b61c09d/3746185353022cc7?lnk=gst&amp;q=Permission+denied+(publickey%2Cpassword)#3746185353022cc7">a
response</a>
in Capistrano's google group.  The fix is damn short:</p><pre><code> default_run_options[:pty] = true
</code></pre><p>I looked up what a <a href="http://en.wikipedia.org/wiki/Pseudo_terminal">pseudo
terminal</a>.  I don't
really see why this provides a fix, but my guess is that setting pty
to true creates a new process separate from the original ssh process.
Running svn within this new process would default to password
authentication after failing to use public key authentication.</p><p>This turned out to be an amazing pain to setup.  But it did let me
step through some of the Capistrano code and appreciate what goes on
under the hood.  It also teaches me to search their <a href="http://groups.google.com/group/capistrano">google
group</a> rather than doing a
general web search.</p>
</div>
<script src="../../../../assets/post-6546d1eaa44666cb1ab3152c118eceec.js" type="text/javascript"></script>
<script>
  //<![CDATA[
    hljs.initHighlightingOnLoad();
  //]]>
</script>
<script type='text/javascript'>
  // HackerNews
  (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.src = '//hnbutton.appspot.com/static/hn.js';
    s.parentNode.insertBefore(g, s);
  }(document, 'script'));

  // Twitter
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");

  // Google Plus
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname  = 'whatcodecraves';
  var disqus_title      = 'Picking at Capistrano';
  var disqus_identifier = '/posts/2008/08/12/picking-at-capistrano';


  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>
<div id='footer'>
<p>
Copyright Jerry Cheung 2007 - 2014 &nbsp;&nbsp;
<a href="https://github.com/jch/whatcoderaves.com">Source for this blog</a>
</p>
</div>
</div>
</body>
</html>
