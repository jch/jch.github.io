<!DOCTYPE html>
<html>
<head>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<title>
Ruby Incompatible Encoding Errors
</title>
<link href="../../../../assets/application-1b6070a43c3e8d37df5eb4ad2c23b344.css" media="all" rel="stylesheet" type="text/css" />
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2747647-1']);
  _gaq.push(['_setSiteSpeedSampleRate', 100]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>
<body class='container-fluid'>
<div class='full-width' id='wcc'>
<div id='header'>
<a href="../../../../index.html">whatcodecraves.com</a>
</div>

<div id='main'>
<div id="carbonads-container">
  <div class="carbonad">
    <div id="azcarbon"></div>
      <script type="text/javascript">
        var z = document.createElement("script");
        z.type = "text/javascript";
        z.async = true;
        z.src = "http://engine.carbonads.com/z/17311/azcarbon_2_1_0_VERT";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(z, s);
      </script>
    </div>
  </div>
<div class='post'>
<h1>Ruby Incompatible Encoding Errors</h1>
<a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
<a href="https://twitter.com/share" class="twitter-share-button" data_via="whatcodecraves">Tweet</a>
<div class='g-plus' data-action='share' data-annontation='bubble'></div>
<p>String encodings is like air. Completely necessary and never on your mind
until something goes wrong. Encoding bugs are painful and often feel like the
black arts. Follow the jump for an aggregation of past experiences for solving
these tricky problems.</p><h2>Background</h2><p>The first time you think of encodings in Ruby is probably the first time you
see an exception along the lines of:</p><pre><code>incompatible character encodings: ASCII-8BIT and UTF-8
</code></pre><p>Before you pull out your hair, I recommend reading <a href="http://blog.grayproductions.net/articles/understanding_m17n">James Edward Grey
II's</a> in depth
coverage on why and what encodings are. Markus Prinz's <a href="http://nuclearsquid.com/writings/ruby-1-9-encodings/">Working with Encodings
in Ruby 1.9</a> is also a
good read. Go ahead, this article will wait.</p><p>The core cause of the above error is when your code tries to mash two strings
with different encodings together. For example, trying to glue a UTF-8 Chinese
string to an ASCII-8BIT English string. They're hard to hunt down because the
error is generated in C code and doesn't descend from the Exception class.
This means you can't <code>rescue</code> the error to inspect it. Your best tool for
finding the origin of the error is to learn about the <a href="http://ruby-doc.org/core-2.0/Encoding.html">Encoding</a>
module. Once you're familiar with that API, it's easy to inspect the encoding
to check it's what you expected.</p><pre><code class="ruby">"some string".encoding
"some string".force_encoding('UTF-8')
</code></pre><h3>Rails</h3><p>Rails defaults to UTF-8 for encoding. You can change it via application.rb
with:</p><pre><code class="ruby">config.encoding = 'UTF-8'
</code></pre><p>Yehuda Katz has a <a href="http://yehudakatz.com/2010/05/05/ruby-1-9-encodings-a-primer-and-the-solution-for-rails/">good write
up</a>
describing the problem. The long term solution is to have
libraries that deal with external strings to respect
<code>Encoding.default_internal</code></p><h3>Databases</h3><p>To make sure your database uses the correct encoding, set your connection
adapter to the correct encoding:</p><pre><code># config/database.yml
development:
  encoding: unicode
</code></pre><h3>Views</h3><p>When template views are read in from the filesystem, it respects the global
ruby default for encoding. This can be overridden by a special shebang-like
declaration at the top of the file:</p><pre><code class="ruby"># encoding: utf-8
</code></pre><p>Check out <a href="http://api.rubyonrails.org/classes/ActionView/Template.html#method-i-encode-21">ActionView::Template#encode!</a>
for more details.</p><p>If you're seeing an incompatible encoding error in a view, it's possible that
it's caused by rendering a value from an external gem or string. Remember that
the <code>render</code> method returns a string. A quick way to inspect that your
partials are in the correct encoding is to save the result of a partial into a
variable and print it's encoding:</p><pre><code class="ruby">&lt;% output = render(:partial =&gt; 'some/partial') %&gt;
&lt;%= output.encoding %&gt;
</code></pre><h3>Heroku</h3><p>Don't <a href="http://stackoverflow.com/questions/7612912/set-utf-8-as-default-%0Astring-encoding-in-heroku">forget to set your environment
variable</a> to the correct default encoding.</p><pre><code class="sh">$ heroku config:add LANG=en_US.UTF-8
</code></pre>
</div>
<script src="../../../../assets/post-6db30d9cd8415ddc540433d54a06699e.js" type="text/javascript"></script>
<script>
  //<![CDATA[
    hljs.initHighlightingOnLoad();
  //]]>
</script>
<script type='text/javascript'>
  // HackerNews
  (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.src = '//hnbutton.appspot.com/static/hn.js';
    s.parentNode.insertBefore(g, s);
  }(document, 'script'));

  // Twitter
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");

  // Google Plus
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname  = 'whatcodecraves';
  var disqus_title      = 'Ruby Incompatible Encoding Errors';
  var disqus_identifier = '/articles/2013/03/05/ruby-incompatible-encoding';


  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>
<div id='footer'>
<p>
Copyright Jerry Cheung 2007 - 2014 &nbsp;&nbsp;
<a href="https://github.com/jch/whatcoderaves.com">Source for this blog</a>
</p>
</div>
</div>
</body>
</html>
