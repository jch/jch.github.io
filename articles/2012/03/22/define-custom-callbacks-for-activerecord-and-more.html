<!DOCTYPE html>
<html>
<head>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<title>
Define Custom Callbacks for ActiveRecord and More
</title>
<link href="../../../../assets/application-1b6070a43c3e8d37df5eb4ad2c23b344.css" media="all" rel="stylesheet" type="text/css" />
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2747647-1']);
  _gaq.push(['_setSiteSpeedSampleRate', 100]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>
<body class='container-fluid'>
<div class='full-width' id='wcc'>
<div id='header'>
<a href="../../../../index.html">whatcodecraves.com</a>
</div>

<div id='main'>
<div id="carbonads-container">
  <div class="carbonad">
    <div id="azcarbon"></div>
      <script type="text/javascript">
        var z = document.createElement("script");
        z.type = "text/javascript";
        z.async = true;
        z.src = "http://engine.carbonads.com/z/17311/azcarbon_2_1_0_VERT";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(z, s);
      </script>
    </div>
  </div>
<div class='post'>
<h1>Define Custom Callbacks for ActiveRecord and More</h1>
<a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
<a href="https://twitter.com/share" class="twitter-share-button" data_via="whatcodecraves">Tweet</a>
<div class='g-plus' data-action='share' data-annontation='bubble'></div>
<p>Rails ActiveRecord models have a lifecycle that developers are allowed to hook into. But while most of us know about <code>before_save</code> and <code>after_update</code>, there are a few lesser unknown callbacks that are good to know about before you reinvent them. In this post, I'll cover all of the available ActiveRecord lifecycle callbacks, and also show how you can define custom callbacks for normal ruby objects.</p><h2>Meet the Callbacks</h2><p>The Rails guide for <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html">ActiveRecord Validations and Callbacks</a> is a good starting point for an introduction of the available callbacks and what they do. Most developers will be familiar with the validation and persistence callbacks, so let's start with these</p><pre><code class="ruby">:before_validation, :after_validation
:before_save, :after_save
:before_create, :after_create
:before_update, :after_update
:before_destroy, :after_destroy
</code></pre><p>The callbacks above are self explanatory and commonly used, but if you're unfamiliar with them, or need a refresher, check out <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html">the Rails guide on the topic</a>.</p><h2>Around Callbacks</h2><p>For <code>save</code>, <code>create</code>, <code>update</code>, and <code>destroy</code>, Rails also gives extra helper methods for defining both a before and after save callback at the same time.</p><p>For example, suppose you wanted to trigger your own custom callback while a model was being destroyed. You can do so by defining and triggering your own callback as follows:</p><pre><code class="ruby">class SomeModel &lt; ActiveRecord::Base
  define_callbacks :custom_callback

  around_destroy :around_callback

  def around_callback
    run_callbacks :custom_callback do
      yield  # runs the actual destroy here
    end
  end
end
</code></pre><h2>Custom Callbacks without ActiveRecord</h2><p>Most of the time, your Rails models will be using <a href="http://yehudakatz.com/2010/01/10/activemodel-make-any-ruby-object-feel-like-activerecord/">ActiveModel</a>, but sometimes it makes sense to use a plain old ruby object. Wouldn't it be nice if we could define callbacks in the same way? Fortunately, the callback system is neatly abstracted into <a href="http://api.rubyonrails.org/classes/ActiveSupport/Callbacks.html">ActiveSupport::Callbacks</a> so it's easy to mix into any ruby class.</p><pre><code class="ruby"># Look Ma, I'm just a normal ruby class!
class Group
  include ActiveSupport::Callbacks
  define_callbacks :user_added

  def initialize(opts = {})
    @users = []
  end

  # Whenever we add a new user to our array, we wrap the code
  # with `run_callbacks`. This will run any defined callbacks
  # in order.
  def add_user(u)
    run_callbacks :user_added do
      @users &lt;&lt; u
    end
  end
end
</code></pre><p>For a fully documented and runnable example, check out <a href="https://github.com/jch/as_callbacks_tutorial">this github project</a>. It'll also give some extra explanation about call order and inheritance.</p><h2>Other Useful Callbacks</h2><ul>
<li><p><strong>:after_initialize</strong> is called right after an object has been unmarshalled from the database. This allows you to do any other custom initialization you want. Instead of defining an <code>initialize</code> method on a model, use this instead.</p></li>
<li><p><strong>:after_find</strong> hasn't been useful in my experience. I haven't run into a case where I wanted to manipulate documents after a find action. It could potentially be useful for metrics and profiling.</p></li>
<li><p><strong>:after_touch</strong>. ActiveRecord allows you to <a href="http://api.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-touch">touch a record</a> or its association to refresh its <code>updated_at</code> attribute. I've found this callback useful to triggering notifications to users after a model has been marked as updated, but not actually changed.</p></li>
<li><p><strong>:after_commit</strong> is an interesting and tricky callback. Whenever ActiveRecord wants to make a change to a record (create, update, destroy), it wraps it around a transaction. <code>after_commit</code> is called after you're positive that something has been written out to the database. Because it is also called for destroys, it makes sense to scope the callback if you intend to use it only for saves. Be warned that after_commit can be tricky to use if you're using nested transactions. That'll probably be the topic of another post though.</p></li>
</ul><pre><code class="ruby"># call for creates, updates, and deletes
after_commit :all_callback

# call for creates and updates
after_commit :my_callback, :if =&gt; :persisted?
</code></pre><ul>
<li>
<strong>:after_rollback</strong> is the complement to <code>after_commit</code>. I haven't used it yet, but I can see it as being useful for doing manual cleanup after a failed transaction.</li>
</ul><h2>Go Forth and Callback!</h2><p>While many of our models will be backed with ActiveRecord, or some ActiveModel compatitible datastore, it's nice to see how easy it is to follow a similar pattern in normal ruby without having to depend on Rails.</p>
</div>
<script src="../../../../assets/post-6db30d9cd8415ddc540433d54a06699e.js" type="text/javascript"></script>
<script>
  //<![CDATA[
    hljs.initHighlightingOnLoad();
  //]]>
</script>
<script type='text/javascript'>
  // HackerNews
  (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.src = '//hnbutton.appspot.com/static/hn.js';
    s.parentNode.insertBefore(g, s);
  }(document, 'script'));

  // Twitter
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");

  // Google Plus
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname  = 'whatcodecraves';
  var disqus_title      = 'Define Custom Callbacks for ActiveRecord and More';
  var disqus_identifier = '/articles/2012/03/22/define-custom-callbacks-for-activerecord-and-more';


  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>
<div id='footer'>
<p>
Copyright Jerry Cheung 2007 - 2014 &nbsp;&nbsp;
<a href="https://github.com/jch/whatcoderaves.com">Source for this blog</a>
</p>
</div>
</div>
</body>
</html>
